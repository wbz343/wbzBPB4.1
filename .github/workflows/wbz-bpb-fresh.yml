name: Auto Update BPB Panel to Latest

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 03:15 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 11:15ï¼‰
    - cron: '15 3 * * *'
  
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # å½“æ›´æ–°æœ¬å·¥ä½œæµæ–‡ä»¶æ—¶ä¹Ÿè§¦å‘
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/update-bpb.yml'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      # æ­¥éª¤ 2: è®¾ç½® Git èº«ä»½ä¿¡æ¯
      - name: Setup Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      # æ­¥éª¤ 3: åˆ›å»ºé™æ€æ–‡ä»¶ç›®å½•ï¼ˆè§£å†³ wrangler æ£€æµ‹é—®é¢˜ï¼‰
      - name: Create static directory structure
        run: |
          # åˆ›å»º Cloudflare Pages æœŸæœ›çš„ç›®å½•ç»“æ„
          echo "ğŸ“ Creating static directory structure for wrangler..."
          
          # åˆ›å»º dist ç›®å½•ï¼ˆCloudflare Pages é»˜è®¤æŸ¥æ‰¾çš„ç›®å½•ï¼‰
          mkdir -p dist
          
          # å¦‚æœå­˜åœ¨ public ç›®å½•ï¼Œä¹Ÿåˆ›å»º
          mkdir -p public
          
          echo "âœ… Created static directories"

      # æ­¥éª¤ 4: è·å–æœ€æ–°ç‰ˆæœ¬æ ‡ç­¾
      - name: Get latest release tag
        id: get_version
        run: |
          # ä½¿ç”¨ GitHub API è·å–æœ€æ–°å‘å¸ƒç‰ˆæœ¬
          LATEST_TAG=$(curl -s -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/bia-pain-bache/BPB-Worker-Panel/releases/latest \
            | grep '"tag_name"' | head -1 | sed -E 's/.*"([^"]+)".*/\1/')
          
          if [ -z "$LATEST_TAG" ]; then
            echo "âŒ Failed to get latest tag"
            exit 1
          fi
          
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV
          echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "Latest BPB version: $LATEST_TAG"

      # æ­¥éª¤ 5: æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
      - name: Check if already up-to-date
        id: check_update
        run: |
          # æ£€æŸ¥å½“å‰ç‰ˆæœ¬è®°å½•æ–‡ä»¶
          if [ -f "current_version.txt" ]; then
            CURRENT_VERSION=$(cat current_version.txt)
            echo "Current version: $CURRENT_VERSION"
            echo "Latest version: $LATEST_TAG"
            
            if [ "$CURRENT_VERSION" = "$LATEST_TAG" ]; then
              echo "âœ… Already at latest version ($LATEST_TAG)"
              echo "skip_update=true" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "ğŸ“¦ Update available: $CURRENT_VERSION -> $LATEST_TAG"
              echo "skip_update=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "ğŸ“ No version record found. First-time setup."
            echo "skip_update=false" >> $GITHUB_OUTPUT
          fi

      # æ­¥éª¤ 6: ä¸‹è½½æœ€æ–°å‘å¸ƒåŒ…
      - name: Download latest release
        if: steps.check_update.outputs.skip_update == 'false'
        run: |
          echo "ğŸ“¥ Downloading worker.zip from release $LATEST_TAG..."
          
          # ä¸‹è½½ worker.zip
          curl -L -o worker.zip \
            "https://github.com/bia-pain-bache/BPB-Worker-Panel/releases/download/$LATEST_TAG/worker.zip"
          
          # éªŒè¯ä¸‹è½½æ˜¯å¦æˆåŠŸ
          if [ ! -f "worker.zip" ]; then
            echo "âŒ Failed to download worker.zip"
            exit 1
          fi
          
          FILE_SIZE=$(ls -lh worker.zip | awk '{print $5}')
          echo "âœ… Downloaded worker.zip ($FILE_SIZE)"

      # æ­¥éª¤ 7: è§£å‹å¹¶éƒ¨ç½²åˆ°é™æ€ç›®å½•
      - name: Extract and deploy to static directory
        if: steps.check_update.outputs.skip_update == 'false'
        run: |
          echo "ğŸ“‚ Extracting worker.zip..."
          
          # åˆ›å»ºä¸´æ—¶æå–ç›®å½•
          mkdir -p temp_extract
          
          # è§£å‹æ–‡ä»¶
          if ! unzip -o worker.zip -d temp_extract/; then
            echo "âŒ Failed to extract worker.zip"
            exit 1
          fi
          
          echo "ğŸ“ Extracted contents:"
          find temp_extract -type f -name "*.html" -o -name "*.js" -o -name "*.css" | head -10
          
          # æ–¹æ³• 1: æ£€æŸ¥æ˜¯å¦æœ‰ dist ç›®å½•ç»“æ„
          if [ -d "temp_extract/dist" ]; then
            echo "âœ… Found dist directory in release"
            # å¤åˆ¶ dist ç›®å½•å†…å®¹åˆ°é¡¹ç›®æ ¹ç›®å½•
            cp -r temp_extract/dist/* ./
          # æ–¹æ³• 2: æ£€æŸ¥æ˜¯å¦æœ‰ public ç›®å½•
          elif [ -d "temp_extract/public" ]; then
            echo "âœ… Found public directory in release"
            cp -r temp_extract/public/* ./
          # æ–¹æ³• 3: ç›´æ¥å¤åˆ¶æ‰€æœ‰é™æ€æ–‡ä»¶åˆ° dist ç›®å½•ï¼ˆCloudflare Pages é»˜è®¤æŸ¥æ‰¾ï¼‰
          else
            echo "ğŸ” No standard static directory found, copying all static files to dist/"
            
            # æ¸…ç©º dist ç›®å½•
            rm -rf dist/*
            
            # æŸ¥æ‰¾å¹¶å¤åˆ¶æ‰€æœ‰é™æ€æ–‡ä»¶åˆ° dist ç›®å½•
            find temp_extract -type f \( -name "*.html" -o -name "*.js" -o -name "*.css" -o -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.gif" -o -name "*.svg" -o -name "*.ico" -o -name "*.woff" -o -name "*.woff2" -o -name "*.ttf" -o -name "*.json" \) \
              -exec cp --parents {} dist/ \;
            
            # å¦‚æœ dist æ˜¯ç©ºçš„ï¼Œå°è¯•ç›´æ¥å¤åˆ¶æ‰€æœ‰æ–‡ä»¶
            if [ -z "$(ls -A dist/ 2>/dev/null)" ]; then
              echo "âš ï¸ dist directory is empty, copying all extracted files"
              cp -r temp_extract/* ./
            fi
          fi
          
          # æ£€æŸ¥å¹¶å¤åˆ¶ _worker.jsï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -f "temp_extract/_worker.js" ]; then
            echo "âœ… Found _worker.js"
            cp temp_extract/_worker.js ./
          else
            # åœ¨å­ç›®å½•ä¸­æŸ¥æ‰¾ _worker.js
            find temp_extract -name "_worker.js" -exec cp {} ./ \;
          fi
          
          # ç¡®ä¿è‡³å°‘æœ‰ index.html æ–‡ä»¶ï¼ˆCloudflare Pages éœ€è¦ï¼‰
          if [ ! -f "index.html" ] && [ ! -f "dist/index.html" ]; then
            echo "âš ï¸ No index.html found, creating a minimal one"
            echo "<!DOCTYPE html>
<html>
<head>
    <title>BPB Panel</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <h1>BPB Panel</h1>
    <p>Application is loading...</p>
    <script src="app.js"></script>
</body>
</html>" > index.html
          fi
          
          # ä¿å­˜ç‰ˆæœ¬ä¿¡æ¯
          echo "$LATEST_TAG" > current_version.txt
          
          # åˆ›å»º Cloudflare Pages é…ç½®æ–‡ä»¶ï¼ˆå¦‚æœéœ€è¦ï¼‰
          if [ ! -f "_routes.json" ]; then
            echo '{
  "version": 1,
  "include": ["/*"],
  "exclude": []
}' > _routes.json
          fi
          
          if [ ! -f "_headers" ]; then
            echo '# Security headers
/*
  X-Frame-Options: DENY
  X-Content-Type-Options: nosniff
  Referrer-Policy: strict-origin-when-cross-origin' > _headers
          fi
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf temp_extract worker.zip
          
          echo "âœ… Files extracted and deployed"
          echo "ğŸ“Š Current directory structure:"
          ls -la

      # æ­¥éª¤ 8: åˆ›å»ºæˆ–æ›´æ–° wrangler.tomlï¼ˆå¯é€‰ï¼‰
      - name: Configure wrangler if needed
        if: steps.check_update.outputs.skip_update == 'false'
        run: |
          # å¦‚æœä¸å­˜åœ¨ wrangler.tomlï¼Œåˆ›å»ºä¸€ä¸ªåŸºç¡€é…ç½®
          if [ ! -f "wrangler.toml" ]; then
            echo "ğŸ“ Creating basic wrangler.toml for Cloudflare Pages"
            
            cat > wrangler.toml << 'EOF'
name = "bpb-panel"
compatibility_date = "$(date +%Y-%m-%d)"
pages_build_output_dir = "dist"
EOF
            
            # å¦‚æœ dist ç›®å½•å­˜åœ¨ä½†ä¸ºç©ºï¼Œåˆ™æ›´æ–°é…ç½®
            if [ -d "dist" ] && [ -n "$(ls -A dist/ 2>/dev/null)" ]; then
              echo 'pages_build_output_dir = "dist"' >> wrangler.toml
            else
              echo 'pages_build_output_dir = "."' >> wrangler.toml
            fi
          fi

      # æ­¥éª¤ 9: æäº¤æ›´æ”¹
      - name: Commit and push changes
        if: steps.check_update.outputs.skip_update == 'false'
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if [ -z "$(git status --porcelain)" ]; then
            echo "âš ï¸ No changes to commit"
            exit 0
          fi
          
          # æ·»åŠ æ‰€æœ‰æ›´æ”¹çš„æ–‡ä»¶
          git add .
          
          # æäº¤æ›´æ”¹
          git commit -m "ğŸ”§ chore: auto-update BPB Panel to $LATEST_TAG [skip ci]"
          
          # æ¨é€æ›´æ”¹
          echo "ğŸš€ Pushing changes to main branch..."
          git push origin main
          
          echo "âœ… Changes committed and pushed"

      # æ­¥éª¤ 10: éƒ¨ç½²åˆ° GitHub Pages
      - name: Setup Pages
        if: steps.check_update.outputs.skip_update == 'false'
        uses: actions/configure-pages@v4

      - name: Upload artifact
        if: steps.check_update.outputs.skip_update == 'false'
        uses: actions/upload-pages-artifact@v3
        with:
          # ä¸Šä¼  dist ç›®å½•æˆ–å½“å‰ç›®å½•
          path: |
            dist/
            ./
          retention-days: 1

      - name: Deploy to GitHub Pages
        if: steps.check_update.outputs.skip_update == 'false'
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # æ­¥éª¤ 11: ç»“æœæ€»ç»“
      - name: Update summary
        run: |
          echo ""
          echo "=========================================="
          echo "           BPB Panel Auto Update          "
          echo "=========================================="
          
          if [ "${{ steps.check_update.outputs.skip_update }}" = "true" ]; then
            echo "ğŸ“Š Status: No update needed"
            echo "âœ… Already at latest version: ${{ env.LATEST_TAG }}"
          else
            echo "ğŸ“Š Status: Update completed successfully!"
            echo "âœ… Updated to version: ${{ env.LATEST_TAG }}"
            echo "âœ… Files updated and committed to main"
            echo "âœ… GitHub Pages deployment triggered"
            
            if [ -d "dist" ] && [ -n "$(ls -A dist/ 2>/dev/null)" ]; then
              echo "ğŸ“ Static files location: dist/"
            else
              echo "ğŸ“ Static files location: root directory"
            fi
            
            # æ£€æŸ¥æ˜¯å¦æœ‰ index.html
            if [ -f "index.html" ] || [ -f "dist/index.html" ]; then
              echo "âœ… Found index.html"
            else
              echo "âš ï¸ Warning: No index.html found"
            fi
          fi
          
          echo ""
          echo "â° Next auto-update:"
          echo "   UTC: 03:15 daily"
          echo "   Beijing/Singapore: 11:15 daily"
          echo "=========================================="
