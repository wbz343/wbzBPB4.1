name: Auto Update BPB Panel to Latest

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 03:15 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 11:15ï¼‰
    - cron: '15 3 * * *'
  
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # å½“æ›´æ–°æœ¬å·¥ä½œæµæ–‡ä»¶æ—¶ä¹Ÿè§¦å‘
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/update-bpb.yml'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      # æ­¥éª¤ 2: è®¾ç½® Git èº«ä»½ä¿¡æ¯
      - name: Setup Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      # æ­¥éª¤ 3: è·å–æœ€æ–°ç‰ˆæœ¬æ ‡ç­¾
      - name: Get latest release tag
        id: get_version
        run: |
          # ä½¿ç”¨ GitHub API è·å–æœ€æ–°å‘å¸ƒç‰ˆæœ¬
          LATEST_TAG=$(curl -s -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/bia-pain-bache/BPB-Worker-Panel/releases/latest \
            | grep '"tag_name"' | head -1 | sed -E 's/.*"([^"]+)".*/\1/')
          
          if [ -z "$LATEST_TAG" ]; then
            echo "âŒ Failed to get latest tag"
            exit 1
          fi
          
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV
          echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "Latest BPB version: $LATEST_TAG"

      # æ­¥éª¤ 4: æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
      - name: Check if already up-to-date
        id: check_update
        run: |
          # æ£€æŸ¥å½“å‰ç‰ˆæœ¬è®°å½•æ–‡ä»¶
          if [ -f "current_version.txt" ]; then
            CURRENT_VERSION=$(cat current_version.txt)
            echo "Current version: $CURRENT_VERSION"
            echo "Latest version: $LATEST_TAG"
            
            if [ "$CURRENT_VERSION" = "$LATEST_TAG" ]; then
              echo "âœ… Already at latest version ($LATEST_TAG)"
              echo "skip_update=true" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "ğŸ“¦ Update available: $CURRENT_VERSION -> $LATEST_TAG"
              echo "skip_update=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "ğŸ“ No version record found. First-time setup."
            echo "skip_update=false" >> $GITHUB_OUTPUT
          fi

      # æ­¥éª¤ 5: ä¸‹è½½æœ€æ–°å‘å¸ƒåŒ…
      - name: Download latest release
        if: steps.check_update.outputs.skip_update == 'false'
        run: |
          echo "ğŸ“¥ Downloading worker.zip from release $LATEST_TAG..."
          
          # ä¸‹è½½ worker.zip
          curl -L -o worker.zip \
            "https://github.com/bia-pain-bache/BPB-Worker-Panel/releases/download/$LATEST_TAG/worker.zip"
          
          # éªŒè¯ä¸‹è½½æ˜¯å¦æˆåŠŸ
          if [ ! -f "worker.zip" ]; then
            echo "âŒ Failed to download worker.zip"
            exit 1
          fi
          
          FILE_SIZE=$(ls -lh worker.zip | awk '{print $5}')
          echo "âœ… Downloaded worker.zip ($FILE_SIZE)"

      # æ­¥éª¤ 6: è§£å‹å¹¶éƒ¨ç½²é™æ€æ–‡ä»¶
      - name: Extract and deploy files
        if: steps.check_update.outputs.skip_update == 'false'
        run: |
          echo "ğŸ“‚ Extracting worker.zip..."
          
          # æ¸…ç†æ—§çš„æå–ç›®å½•
          rm -rf extracted
          
          # åˆ›å»ºæå–ç›®å½•
          mkdir -p extracted
          
          # è§£å‹æ–‡ä»¶
          if ! unzip -o worker.zip -d extracted/; then
            echo "âŒ Failed to extract worker.zip"
            exit 1
          fi
          
          echo "ğŸ“ Extracted contents:"
          ls -la extracted/
          
          # æ£€æŸ¥è§£å‹å†…å®¹ç»“æ„
          if [ -f "extracted/_worker.js" ]; then
            echo "âœ… Found _worker.js in root of extracted files"
            cp extracted/_worker.js ./
          else
            # å°è¯•åœ¨å­ç›®å½•ä¸­æŸ¥æ‰¾
            echo "ğŸ” Looking for _worker.js in subdirectories..."
            find extracted -name "_worker.js" -exec cp {} ./ \;
          fi
          
          # å¤åˆ¶æ‰€æœ‰é™æ€æ–‡ä»¶åˆ°å½“å‰ç›®å½•
          echo "ğŸ“„ Copying static files..."
          
          # æŸ¥æ‰¾å¹¶å¤åˆ¶ HTML æ–‡ä»¶
          find extracted -name "*.html" -exec cp {} ./ \;
          
          # æŸ¥æ‰¾å¹¶å¤åˆ¶ JS æ–‡ä»¶
          find extracted -name "*.js" ! -path "*/node_modules/*" -exec cp {} ./ \;
          
          # æŸ¥æ‰¾å¹¶å¤åˆ¶ CSS æ–‡ä»¶
          find extracted -name "*.css" -exec cp {} ./ \;
          
          # æŸ¥æ‰¾å¹¶å¤åˆ¶å…¶ä»–é™æ€èµ„æº
          find extracted -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.gif" -o -name "*.svg" -o -name "*.ico" -o -name "*.woff" -o -name "*.woff2" -o -name "*.ttf" -o -name "*.json" | while read file; do
            cp "$file" ./
          done
          
          # æ£€æŸ¥æ˜¯å¦å¤åˆ¶äº†å¿…è¦çš„æ–‡ä»¶
          echo "ğŸ“Š Files copied to repository root:"
          ls -la *.html *.js *.css 2>/dev/null || true
          
          # ä¿å­˜ç‰ˆæœ¬ä¿¡æ¯
          echo "$LATEST_TAG" > current_version.txt
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf extracted worker.zip
          
          echo "âœ… Files extracted and copied successfully"

      # æ­¥éª¤ 7: æäº¤æ›´æ”¹
      - name: Commit and push changes
        if: steps.check_update.outputs.skip_update == 'false'
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if [ -z "$(git status --porcelain)" ]; then
            echo "âš ï¸ No changes to commit"
            exit 0
          fi
          
          # æ·»åŠ æ‰€æœ‰æ›´æ”¹çš„æ–‡ä»¶
          git add .
          
          # æäº¤æ›´æ”¹
          git commit -m "ğŸ”§ chore: auto-update BPB Panel to $LATEST_TAG [skip ci]"
          
          # æ¨é€æ›´æ”¹
          echo "ğŸš€ Pushing changes to main branch..."
          git push origin main
          
          echo "âœ… Changes committed and pushed"

      # æ­¥éª¤ 8: éƒ¨ç½²åˆ° GitHub Pages
      - name: Deploy to GitHub Pages
        if: steps.check_update.outputs.skip_update == 'false'
        uses: actions/deploy-pages@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          error_count: 1
          timeout: 600000

      # æ­¥éª¤ 9: éƒ¨ç½²çŠ¶æ€è¾“å‡º
      - name: Get deployment status
        id: deployment
        run: |
          echo "âœ… Deployment completed successfully"
          echo "page_url=https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}" >> $GITHUB_OUTPUT

      # æ­¥éª¤ 10: ç»“æœæ€»ç»“
      - name: Update summary
        run: |
          echo "=========================================="
          echo "           BPB Panel Auto Update          "
          echo "=========================================="
          
          if [ "${{ steps.check_update.outputs.skip_update }}" = "true" ]; then
            echo "ğŸ“Š Status: No update needed"
            echo "âœ… Already at latest version: $LATEST_TAG"
          else
            echo "ğŸ“Š Status: Update completed successfully!"
            echo "âœ… Updated to version: $LATEST_TAG"
            echo "âœ… Files updated and committed to main"
            echo "âœ… GitHub Pages deployment triggered"
            echo "ğŸŒ Site URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
          fi
          
          echo ""
          echo "â° Next auto-update:"
          echo "   UTC: 03:15 daily"
          echo "   Beijing/Singapore: 11:15 daily"
          echo "=========================================="
